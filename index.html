<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
 content="width=device-width,
 initial-scale=1.0,
 maximum-scale=1.0,
 user-scalable=no,
 viewport-fit=cover">
<title>Blood of the Ronin</title>

<style>
body{margin:0;background:black;overflow:hidden;}
canvas{position:fixed;top:0;left:0;image-rendering:pixelated;}

#ui{
 position:fixed;
 bottom:0;
 width:100%;
 height:120px;
 padding-bottom:env(safe-area-inset-bottom);
 background:linear-gradient(#1a0000,#000);
 border-top:3px solid #550000;
 display:flex;
 align-items:center;
 justify-content:space-between;
 padding:0 25px;
 box-sizing:border-box;
}

#movePad{position:relative;width:90px;height:90px;border-radius:50%;
 background:rgba(255,255,255,.08);border:2px solid #555;}
#stick{position:absolute;width:40px;height:40px;border-radius:50%;
 background:rgba(255,255,255,.4);left:25px;top:25px;}

#hpContainer{flex:1;margin:0 20px;height:18px;background:#330000;
 border:2px solid #990000;}
#hpBar{height:100%;width:100%;background:#ff0000;}

#attackBtn{
 width:90px;height:90px;border-radius:50%;
 background:#990000;border:3px solid #ff4444;
 display:flex;align-items:center;justify-content:center;
 font-size:26px;color:white;transition:.1s;
}
#attackBtn.active{
 background:#ff0000;transform:scale(.85);
 box-shadow:0 0 25px #ff0000;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="ui">
 <div id="movePad"><div id="stick"></div></div>
 <div id="hpContainer"><div id="hpBar"></div></div>
 <div id="attackBtn">‚öî</div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const uiHeight=120;

function resize(){
 canvas.width=window.innerWidth;
 canvas.height=window.innerHeight-uiHeight;
}
resize();
window.addEventListener("resize",resize);

/* ===== ÌîåÎ†àÏù¥Ïñ¥ ===== */
let player={
 x:canvas.width/2,
 y:canvas.height/2,
 hp:100,
 dir:0,
 radius:14,
 speed:2,
 walkFrame:0
};

let enemies=[];
for(let i=0;i<6;i++){
 enemies.push({
  x:Math.random()*canvas.width,
  y:Math.random()*canvas.height,
  hp:40,
  radius:14,
  knockX:0,
  knockY:0
 });
}

let particles=[];
let slashTrails=[];
let attacking=false;
let attackTimer=0;
let shake=0;

/* ===== Ï°∞Ïù¥Ïä§Ìã± ===== */
const pad=document.getElementById("movePad");
const stick=document.getElementById("stick");
let joyActive=false,joyDX=0,joyDY=0;

pad.addEventListener("touchstart",()=>joyActive=true);
pad.addEventListener("touchmove",e=>{
 if(!joyActive)return;
 let rect=pad.getBoundingClientRect();
 let x=e.touches[0].clientX-rect.left-45;
 let y=e.touches[0].clientY-rect.top-45;
 let dist=Math.hypot(x,y);
 let max=30;
 if(dist>max){x*=max/dist;y*=max/dist;}
 stick.style.left=(x+45-20)+"px";
 stick.style.top=(y+45-20)+"px";
 joyDX=x/max; joyDY=y/max;
});
pad.addEventListener("touchend",()=>{
 joyActive=false; joyDX=joyDY=0;
 stick.style.left="25px"; stick.style.top="25px";
});

/* ===== Í≥µÍ≤© ===== */
const attackBtn=document.getElementById("attackBtn");
attackBtn.addEventListener("touchstart",()=>{
 attacking=true;
 attackTimer=12;
 attackBtn.classList.add("active");
});
attackBtn.addEventListener("touchend",()=>{
 attackBtn.classList.remove("active");
});

/* ===== ÏóÖÎç∞Ïù¥Ìä∏ ===== */
function update(){

 /* Ïù¥Îèô */
 player.x+=joyDX*player.speed*3;
 player.y+=joyDY*player.speed*3;
 if(joyDX||joyDY){
  player.dir=Math.atan2(joyDY,joyDX);
  player.walkFrame=(player.walkFrame+1)%20;
 }

 /* Ï†Å Ïù¥Îèô */
 enemies.forEach(e=>{
  let dx=player.x-e.x;
  let dy=player.y-e.y;
  let dist=Math.hypot(dx,dy);
  if(dist>1){
   e.x+=dx/dist*0.5;
   e.y+=dy/dist*0.5;
  }

  e.x+=e.knockX;
  e.y+=e.knockY;
  e.knockX*=0.85;
  e.knockY*=0.85;
 });

 /* Ï∂©Îèå Î∂ÑÎ¶¨ */
 enemies.forEach(e=>{
  let dx=e.x-player.x;
  let dy=e.y-player.y;
  let dist=Math.hypot(dx,dy);
  let minDist=player.radius+e.radius;
  if(dist<minDist){
   let overlap=minDist-dist;
   let nx=dx/dist;
   let ny=dy/dist;
   e.x+=nx*overlap*0.5;
   e.y+=ny*overlap*0.5;
   player.x-=nx*overlap*0.5;
   player.y-=ny*overlap*0.5;
  }
 });

 /* Î∂ÄÏ±ÑÍº¥ Í≥µÍ≤© */
 if(attacking){
  attackTimer--;

  enemies.forEach(e=>{
   let dx=e.x-player.x;
   let dy=e.y-player.y;
   let dist=Math.hypot(dx,dy);
   if(dist<90){
    let angle=Math.atan2(dy,dx);
    let diff=Math.abs(angle-player.dir);
    if(diff<0.8){
     e.hp-=20;

     // ÎÑâÎ∞±
     let force=6;
     e.knockX=Math.cos(player.dir)*force;
     e.knockY=Math.sin(player.dir)*force;

     spawnBlood(e.x,e.y);
     shake=8;
    }
   }
  });

  // Í∂§Ï†Å Ï∂îÍ∞Ä
  slashTrails.push({
   x:player.x,
   y:player.y,
   angle:player.dir,
   life:10
  });

  if(attackTimer<=0)attacking=false;
 }

 slashTrails.forEach(t=>t.life--);
 slashTrails=slashTrails.filter(t=>t.life>0);

 enemies=enemies.filter(e=>e.hp>0);

 particles.forEach(p=>{
  p.x+=p.vx;p.y+=p.vy;p.life--;
 });
 particles=particles.filter(p=>p.life>0);

 if(shake>0)shake--;

 document.getElementById("hpBar").style.width=player.hp+"%";
}

/* ===== Ïù¥ÌéôÌä∏ ===== */
function spawnBlood(x,y){
 for(let i=0;i<6;i++){
  particles.push({
   x,y,
   vx:(Math.random()-0.5)*4,
   vy:(Math.random()-0.5)*4,
   life:15
  });
 }
}

/* ===== Î†åÎçî ===== */
function draw(){
 ctx.save();
 if(shake>0)
  ctx.translate((Math.random()-0.5)*shake,
                (Math.random()-0.5)*shake);

 ctx.fillStyle="#111";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 enemies.forEach(e=>drawGoblin(e.x,e.y));
 drawOni(player.x,player.y);

 // Í≤Ä Í∂§Ï†Å
 slashTrails.forEach(t=>{
  ctx.save();
  ctx.globalAlpha=t.life/10;
  ctx.translate(t.x,t.y);
  ctx.rotate(t.angle);
  ctx.fillStyle="#ffffff";
  ctx.fillRect(0,-4,40,8);
  ctx.restore();
 });

 ctx.fillStyle="#aa0000";
 particles.forEach(p=>ctx.fillRect(p.x,p.y,3,3));

 ctx.restore();
}

/* ===== Ïò§Îãà ===== */
function drawOni(x,y){

 // 4Î∞©Ìñ• Í±∑Í∏∞ (Í∞ÑÎã® ÎèÑÌä∏ ÌùîÎì§Î¶º)
 let bob = (player.walkFrame<10)? -1:1;

 ctx.fillStyle="#880000";
 ctx.fillRect(x-12,y-12+bob,24,24);

 ctx.fillStyle="#cc0000";
 ctx.fillRect(x-8,y-20+bob,16,8);

 // Îøî Î≥µÍµ¨ üëπ
 ctx.fillStyle="#ffffcc";
 ctx.fillRect(x-10,y-26+bob,5,8);
 ctx.fillRect(x+5,y-26+bob,5,8);

 ctx.fillStyle="#fff";
 ctx.fillRect(x-4,y-14+bob,3,3);
 ctx.fillRect(x+1,y-14+bob,3,3);

 // Ìåî 2ÌîÑÎ†àÏûÑ
 if(attacking){
  ctx.save();
  let swingOffset=(attackTimer%6<3)? -0.5:0.5;
  ctx.translate(x,y);
  ctx.rotate(player.dir+swingOffset);
  ctx.fillStyle="#ddd";
  ctx.fillRect(10,-3,40,6);
  ctx.restore();
 }
}

/* ===== ÎèÑÍπ®ÎπÑ ===== */
function drawGoblin(x,y){
 ctx.fillStyle="#004400";
 ctx.fillRect(x-12,y-12,24,24);
 ctx.fillStyle="#00aa00";
 ctx.fillRect(x-8,y-20,16,8);
 ctx.fillStyle="#fff";
 ctx.fillRect(x-4,y-15,3,3);
 ctx.fillRect(x+2,y-15,3,3);
}

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
