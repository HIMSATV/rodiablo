<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dark Axe</title>
<style>
body{margin:0;background:#050505;overflow:hidden;}
canvas{display:block;}

#hpBar{
 position:fixed;
 top:15px;
 left:50%;
 transform:translateX(-50%);
 width:240px;
 height:20px;
 background:#220000;
 border:2px solid #aa0000;
}
#hpFill{height:100%;width:100%;background:linear-gradient(to right,#ff0000,#aa0000);}

#uiBar{
 position:fixed;
 bottom:0;
 width:100%;
 height:140px;
 background:linear-gradient(#1a0000,#000);
 border-top:3px solid #550000;
}

#joystickBase{
 position:absolute;
 left:40px;
 bottom:20px;
 width:120px;height:120px;
 border-radius:50%;
 background:rgba(255,255,255,0.08);
}
#joystick{
 position:absolute;
 width:60px;height:60px;
 border-radius:50%;
 background:rgba(255,255,255,0.25);
 left:30px;top:30px;
}

#attackBtn{
 position:absolute;
 right:40px;
 bottom:35px;
 width:90px;height:90px;
 border-radius:50%;
 background:radial-gradient(circle,#aa0000,#440000);
 border:3px solid #ff4444;
 display:flex;align-items:center;justify-content:center;
 color:white;font-size:22px;
}
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="hpBar"><div id="hpFill"></div></div>

<div id="uiBar">
 <div id="joystickBase"><div id="joystick"></div></div>
 <div id="attackBtn">⚔</div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight-140;

/* ===== 플레이어 ===== */
let player={
 x:canvas.width/2,
 y:canvas.height/2,
 dir:0,
 speed:2,
 radius:20,
 hp:100,
 maxHp:100,
 invincible:0
};

let enemies=[];
let particles=[];
let attacking=false;
let attackCooldown=0;
let screenShake=0;

/* 적 생성 */
function spawnEnemy(){
 enemies.push({
  x:Math.random()*canvas.width,
  y:Math.random()*canvas.height,
  hp:50,
  radius:18,
  attackCooldown:0
 });
}
for(let i=0;i<6;i++) spawnEnemy();

/* 자동 타겟 */
function findClosest(){
 let min=9999,target=null;
 enemies.forEach(e=>{
  let d=Math.hypot(e.x-player.x,e.y-player.y);
  if(d<min){min=d;target=e;}
 });
 return target;
}

/* 공격 */
document.getElementById("attackBtn").addEventListener("touchstart",attack);
document.getElementById("attackBtn").addEventListener("mousedown",attack);

function attack(){
 if(attackCooldown>0) return;
 let target=findClosest();
 if(!target) return;

 let dx=target.x-player.x;
 let dy=target.y-player.y;
 let dist=Math.hypot(dx,dy);
 if(dist>130) return;

 player.dir=Math.atan2(dy,dx);
 attacking=true;
 attackCooldown=25;

 enemies.forEach(e=>{
  let dx=e.x-player.x;
  let dy=e.y-player.y;
  let dist=Math.hypot(dx,dy);
  let angle=Math.atan2(dy,dx);
  let diff=Math.abs(angle-player.dir);

  if(dist<110 && diff<0.9){
   e.hp-=25;
   spawnBlood(e.x,e.y);
   if(e.hp<=0){
     explode(e.x,e.y);
     screenShake=14;
   }
  }
 });

 setTimeout(()=>attacking=false,200);
}

/* 이펙트 */
function explode(x,y){
 for(let i=0;i<25;i++){
  particles.push({
   x,y,
   vx:(Math.random()-0.5)*8,
   vy:(Math.random()-0.5)*8,
   life:40,
   color:"orange"
  });
 }
}
function spawnBlood(x,y){
 for(let i=0;i<12;i++){
  particles.push({
   x,y,
   vx:(Math.random()-0.5)*5,
   vy:(Math.random()-0.5)*5,
   life:30,
   color:"red"
  });
 }
}

/* 조이스틱 */
let joyActive=false,joyDX=0,joyDY=0;
const base=document.getElementById("joystickBase");
const stick=document.getElementById("joystick");

base.addEventListener("touchstart",()=>joyActive=true);
base.addEventListener("touchmove",e=>{
 if(!joyActive)return;
 let r=base.getBoundingClientRect();
 let x=e.touches[0].clientX-r.left;
 let y=e.touches[0].clientY-r.top;
 joyDX=x-60; joyDY=y-60;
 let d=Math.hypot(joyDX,joyDY);
 if(d>50){joyDX=joyDX/d*50;joyDY=joyDY/d*50;}
 stick.style.left=(joyDX+30)+"px";
 stick.style.top=(joyDY+30)+"px";
});
base.addEventListener("touchend",()=>{
 joyActive=false;joyDX=joyDY=0;
 stick.style.left="30px";stick.style.top="30px";
});

/* 충돌 */
function resolveCollision(a,b){
 let dx=a.x-b.x;
 let dy=a.y-b.y;
 let dist=Math.hypot(dx,dy);
 let min=a.radius+b.radius;
 if(dist<min && dist>0){
  let push=(min-dist)/2;
  a.x+=dx/dist*push;
  a.y+=dy/dist*push;
  b.x-=dx/dist*push;
  b.y-=dy/dist*push;
 }
}

/* 업데이트 */
function update(){
 if(joyActive){
  player.x+=joyDX/50*player.speed;
  player.y+=joyDY/50*player.speed;
 }

 enemies.forEach(e=>{
  let dx=player.x-e.x;
  let dy=player.y-e.y;
  let dist=Math.hypot(dx,dy);
  if(dist>0){
   e.x+=dx/dist*0.7;
   e.y+=dy/dist*0.7;
  }
  resolveCollision(player,e);
 });

 enemies=enemies.filter(e=>e.hp>0);
 if(enemies.length<6) spawnEnemy();

 particles.forEach(p=>{
  p.x+=p.vx;p.y+=p.vy;p.life--;
 });
 particles=particles.filter(p=>p.life>0);

 if(attackCooldown>0) attackCooldown--;
 if(screenShake>0) screenShake--;

 document.getElementById("hpFill").style.width=
   (player.hp/player.maxHp*100)+"%";
}

/* ===== 캐릭터 디자인 ===== */
function drawPlayer(x,y){

 ctx.save();
 ctx.translate(x,y);

 // 그림자
 ctx.fillStyle="black";
 ctx.beginPath();
 ctx.ellipse(0,22,24,10,0,0,Math.PI*2);
 ctx.fill();

 // 망토
 ctx.fillStyle="#400000";
 ctx.beginPath();
 ctx.moveTo(-18,-5);
 ctx.lineTo(18,-5);
 ctx.lineTo(0,25);
 ctx.fill();

 // 몸통
 ctx.fillStyle="#8b0000";
 ctx.fillRect(-12,-8,24,28);

 // 머리
 ctx.fillStyle="#aa0000";
 ctx.beginPath();
 ctx.arc(0,-18,12,0,Math.PI*2);
 ctx.fill();

 // 뿔
 ctx.fillStyle="#dddddd";
 ctx.beginPath();
 ctx.moveTo(-6,-25);
 ctx.lineTo(-2,-40);
 ctx.lineTo(2,-25);
 ctx.fill();

 ctx.beginPath();
 ctx.moveTo(6,-25);
 ctx.lineTo(2,-40);
 ctx.lineTo(-2,-25);
 ctx.fill();

 // 눈
 ctx.fillStyle="yellow";
 ctx.fillRect(-5,-20,4,4);
 ctx.fillRect(1,-20,4,4);

 /* ===== 도끼 ===== */
 ctx.save();
 ctx.rotate(player.dir);

 let swing = attacking ? Math.sin(Date.now()/40)*1.3 : 0;
 ctx.rotate(swing);

 // 자루
 ctx.fillStyle="#5a3a1a";
 ctx.fillRect(0,-4,65,8);

 // 양날 도끼 (곡선형 느낌)
 ctx.fillStyle="#c9c0a0";

 ctx.beginPath();
 ctx.arc(65,0,22,Math.PI*0.3,Math.PI*1.7);
 ctx.fill();

 ctx.beginPath();
 ctx.arc(65,0,22,-Math.PI*0.7,Math.PI*0.7);
 ctx.fill();

 ctx.restore();
 ctx.restore();
}

/* ===== 몬스터 디자인 ===== */
function drawGoblin(x,y){
 ctx.save();
 ctx.translate(x,y);

 ctx.fillStyle="#002200";
 ctx.beginPath();
 ctx.arc(0,0,18,0,Math.PI*2);
 ctx.fill();

 ctx.fillStyle="#00aa00";
 ctx.beginPath();
 ctx.arc(-4,-5,10,0,Math.PI*2);
 ctx.fill();

 ctx.fillStyle="red";
 ctx.fillRect(-6,-2,4,4);
 ctx.fillRect(2,-2,4,4);

 ctx.fillStyle="white";
 ctx.fillRect(-4,5,8,4);

 ctx.restore();
}

function draw(){
 ctx.save();
 if(screenShake>0){
  ctx.translate(
   (Math.random()-0.5)*screenShake,
   (Math.random()-0.5)*screenShake
  );
 }

 ctx.fillStyle="#0b0b0b";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 enemies.forEach(e=>drawGoblin(e.x,e.y));
 drawPlayer(player.x,player.y);

 particles.forEach(p=>{
  ctx.fillStyle=p.color;
  ctx.fillRect(p.x,p.y,3,3);
 });

 ctx.restore();
}

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
