<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Oni Samurai</title>
<style>
body{
  margin:0;
  background:black;
  overflow:hidden;
  touch-action:none;
}
canvas{position:fixed;top:0;left:0;image-rendering:pixelated;}
#ui{
 position:fixed;bottom:0;width:100%;height:120px;
 background:#111;border-top:3px solid #550000;
 display:flex;align-items:center;justify-content:space-between;
 padding:0 25px;box-sizing:border-box;
}
#movePad{position:relative;width:90px;height:90px;border-radius:50%;background:#222;}
#stick{position:absolute;width:40px;height:40px;border-radius:50%;background:#666;left:25px;top:25px;}
#attackBtn{
 width:90px;height:90px;border-radius:50%;
 background:#990000;border:3px solid #ff4444;
 display:flex;align-items:center;justify-content:center;
 font-size:26px;color:white;
}
#attackBtn.active{background:red;transform:scale(.85);}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="ui">
 <div id="movePad"><div id="stick"></div></div>
 <div id="attackBtn">‚öî</div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const uiHeight=120;

function resize(){
 canvas.width=window.innerWidth;
 canvas.height=window.innerHeight-uiHeight;
}
resize();
window.addEventListener("resize",resize);

/* ===== ÏÇ¨Ïö¥Îìú ===== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function swingSound(){
 let o=audioCtx.createOscillator();
 let g=audioCtx.createGain();
 o.type="sawtooth";
 o.frequency.setValueAtTime(700,audioCtx.currentTime);
 o.frequency.exponentialRampToValueAtTime(200,audioCtx.currentTime+0.12);
 g.gain.value=0.15;
 o.connect(g); g.connect(audioCtx.destination);
 o.start(); o.stop(audioCtx.currentTime+0.12);
}
function hitSound(){
 let o=audioCtx.createOscillator();
 let g=audioCtx.createGain();
 o.type="square";
 o.frequency.value=100;
 g.gain.value=0.25;
 o.connect(g); g.connect(audioCtx.destination);
 o.start(); o.stop(audioCtx.currentTime+0.08);
}

/* ===== ÌîåÎ†àÏù¥Ïñ¥ ===== */
let player={
 x:0,y:0,
 dir:"left",
 speed:2,
 radius:14,
 hp:100,maxHp:100,
 invul:0,
 knockbackX:0,
 knockbackY:0,
  ki:0,
maxKi:100,

ultiActive:false,
ultiCount:0,
ultiTimer:0,
}; 
  
let slowMotion = 0;
  
let enemies=[];
let particles=[];
let bloodPools=[];
let shake=0;
let killCount = 0;
for(let i=0;i<50;i++){
 enemies.push({
  x:(Math.random()-0.5)*600,
  y:(Math.random()-0.5)*600,
  hp:40,
  radius:14,
  stun:0,
  attackFrame:0,
  swingDir:1
 });
}

/* ===== ÏûÖÎ†• ===== */
let joyDX=0,joyDY=0;
let attacking=false;
let attackFrame=0;

const pad=document.getElementById("movePad");
const stick=document.getElementById("stick");
const attackBtn=document.getElementById("attackBtn");
let joyActive=false;

pad.addEventListener("touchstart",()=>joyActive=true);
pad.addEventListener("touchmove",e=>{
 if(!joyActive)return;
 let r=pad.getBoundingClientRect();
 let x=e.touches[0].clientX-r.left-45;
 let y=e.touches[0].clientY-r.top-45;
 let d=Math.hypot(x,y);
 let max=30;
 if(d>max){x*=max/d;y*=max/d;}
 stick.style.left=(x+25)+"px";
 stick.style.top=(y+25)+"px";
 joyDX=x/max; joyDY=y/max;

 if(Math.abs(x)>Math.abs(y))
  player.dir=x>0?"right":"left";
 else
  player.dir=y>0?"down":"up";
});
pad.addEventListener("touchend",()=>{
 joyActive=false;joyDX=joyDY=0;
 stick.style.left="25px";stick.style.top="25px";
});

attackBtn.addEventListener("touchstart",()=>{

  // üî• ===== ÌïÑÏÇ¥Í∏∞ Î∞úÎèô Ìä∏Î¶¨Í±∞ =====
  if(player.ki >= player.maxKi && enemies.length > 0 && !player.ultiActive){

    player.ki = 0;
    player.ultiActive = true;
    player.ultiCount = 0;
    player.ultiTimer = 0;

    return; // ÏùºÎ∞ò Í≥µÍ≤© ÎßâÍ∏∞
  }

  // ===== ÏùºÎ∞ò Í≥µÍ≤© =====
  attacking = true;
  attackFrame = 0;
  swingSound();
  attackBtn.classList.add("active");
});

attackBtn.addEventListener("touchend",()=>{
 attackBtn.classList.remove("active");
});

/* ===== Ï∂©Îèå ===== */
function circleCollide(a,b){
 return Math.hypot(a.x-b.x,a.y-b.y) < a.radius + b.radius;
}

/* ===== ÏóÖÎç∞Ïù¥Ìä∏ ===== */
function update(){
if(player.ultiActive){

  player.ultiTimer++;

  // 10ÌîÑÎ†àÏûÑÎßàÎã§ ÏàúÍ∞ÑÏù¥Îèô+Í≥µÍ≤©
  if(player.ultiTimer % 10 === 0){

    if(enemies.length > 0){

      // ÎûúÎç§ Ï†Å ÏÑ†ÌÉù
      let target = enemies[Math.floor(Math.random() * enemies.length)];

      // ÏàúÍ∞ÑÏù¥Îèô
      player.x = target.x;
      player.y = target.y;

      // 2Î∞∞ Îç∞ÎØ∏ÏßÄ
      let radius = 60;
let hitSomeone = false;

enemies.forEach(e=>{
  let dx = e.x - player.x;
  let dy = e.y - player.y;
  let dist = Math.hypot(dx,dy);

  if(dist < radius){
    e.hp -= 35;
    e.stun = 15;
    hitSomeone = true;
  }
});

// üî• ÏµúÏÜå Ìïú Î™ÖÏù¥ÎùºÎèÑ ÎßûÏïòÏùÑ ÎïåÎßå ÏÇ¨Ïö¥Îìú
if(hitSomeone){
  hitSound();
}

      shake = 15;
    }

    player.ultiCount++;
  }

  // 5Î≤à Î∞òÎ≥µ ÌõÑ Ï¢ÖÎ£å
  if(player.ultiCount >= 5){
    player.ultiActive = false;
  }

  return; // Í∂ÅÍ∑πÍ∏∞ Ï§ëÏóî ÏùºÎ∞ò ÌñâÎèô Ï§ëÏßÄ
}
  if(slowMotion > 0){
  slowMotion--;
  return;   // üî• Î™®Îì† ÏóÖÎç∞Ïù¥Ìä∏ ÏùºÏãúÏ†ïÏßÄ
}
 player.x+=joyDX*player.speed*0.5;
 player.y+=joyDY*player.speed*0.5;
// üî• ÎÑâÎ∞± Ï†ÅÏö©
player.x += player.knockbackX;
player.y += player.knockbackY;

// ÏÑúÏÑúÌûà Í∞êÏÜç
player.knockbackX *= 0.85;
player.knockbackY *= 0.85;
 if(player.invul>0) player.invul--;

 enemies.forEach(e=>{
  let dx=player.x-e.x;
  let dy=player.y-e.y;
  let dist=Math.hypot(dx,dy);

  if(e.stun>0){ e.stun--; return; }

  if(circleCollide(player,e)){
   let overlap = player.radius + e.radius - dist;
   let nx=dx/dist;
   let ny=dy/dist;
   e.x-=nx*overlap*0.5;
   e.y-=ny*overlap*0.5;
  }

  if(dist<45 && e.attackFrame===0){
  e.attackFrame = 25;

  let dx = player.x - e.x;

  // üî• ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏôºÏ™ΩÏù¥Î©¥ -1, Ïò§Î•∏Ï™ΩÏù¥Î©¥ 1
  e.swingDir = dx < 0 ? -1 : 1;
}

  if(e.attackFrame > 0){
  e.attackFrame--;

  if(e.attackFrame === 5 && player.invul === 0){

    let dx = player.x - e.x;
    let dy = player.y - e.y;
    let dist = Math.hypot(dx, dy);

    if(dist > 0){

      let nx = dx / dist;
      let ny = dy / dist;

      // üî• Ï†ÅÏùò Í≥µÍ≤© Î∞©Ìñ• Î≤°ÌÑ∞ (ÌîåÎ†àÏù¥Ïñ¥ Ï™Ω)
      // Í≥µÍ≤©ÏùÄ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏûàÎäî Î∞©Ìñ•Ïù¥Î©¥ Ìï≠ÏÉÅ ÌóàÏö©
      let dot = nx*dx + ny*dy;

      if(dot > 0){

  player.hp -= 10;
  player.invul = 30;
  shake = 10;

  // üî• ÎÑâÎ∞± Î∞©Ìñ• (Ï†Å ‚Üí ÌîåÎ†àÏù¥Ïñ¥ Î∞òÎåÄ Î∞©Ìñ•)
  let pushPower = 8;

  player.knockbackX = nx * pushPower;
  player.knockbackY = ny * pushPower;
}
    }
  }

  return;
}

  if(dist>1){
   e.x+=dx/dist*0.8;
   e.y+=dy/dist*0.8;
  }
 });
// ===== Î™¨Ïä§ÌÑ∞ÎÅºÎ¶¨ Ï∂©Îèå Ï≤òÎ¶¨ =====
for(let i=0;i<enemies.length;i++){
  for(let j=i+1;j<enemies.length;j++){

    let a = enemies[i];
    let b = enemies[j];

    let dx = b.x - a.x;
    let dy = b.y - a.y;
    let dist = Math.hypot(dx,dy);

    let minDist = a.radius + b.radius;

    if(dist < minDist && dist > 0){

      let overlap = minDist - dist;
      let nx = dx / dist;
      let ny = dy / dist;

      // ÏÑúÎ°ú Î∞òÏî© Î∞ÄÏñ¥ÎÉÑ
      a.x -= nx * overlap * 0.5;
      a.y -= ny * overlap * 0.5;

      b.x += nx * overlap * 0.5;
      b.y += ny * overlap * 0.5;
    }
  }
}
 if(attacking){
  attackFrame++;
  if(attackFrame===3)checkHit();
  if(attackFrame>8)attacking=false;
 }

 particles.forEach(p=>{
  p.x+=p.vx;
  p.y+=p.vy;
  p.life--;
 });
 particles=particles.filter(p=>p.life>0);

 if(shake>0)shake--;
}

/* ===== Í≥µÍ≤© ===== */
function checkHit(){

  let range = 45;

  enemies.forEach(e => {

    let dx = e.x - player.x;
    let dy = e.y - player.y;
    let dist = Math.hypot(dx, dy);

    // üî• Í∏∞Ï°¥ Í±∞Î¶¨ Ï≤¥ÌÅ¨ Ïú†ÏßÄ
    if(dist > range + e.radius) return;

    // üî• Î∞©Ìñ• Ï†úÌïú Ï∂îÍ∞Ä
    if(player.dir === "up" && dy >= 0) return;
    if(player.dir === "down" && dy <= 0) return;
    if(player.dir === "right" && dx <= 0) return;
    if(player.dir === "left" && dx >= 0) return;

    // ===== Ïó¨Í∏∞ ÎèÑÎã¨ÌïòÎ©¥ Í≥µÍ≤© ÏÑ±Í≥µ =====

    e.hp -= 20;
    e.stun = 15;

    let len = dist || 1;
    let nx = dx / len;
    let ny = dy / len;

    e.x += nx * 18;
    e.y += ny * 18;

    hitSound();
    shake = 12;

    for(let i=0;i<20;i++){
      particles.push({
        x:e.x,
        y:e.y,
        vx:nx*4 + (Math.random()-0.5)*4,
        vy:ny*4 + (Math.random()-0.5)*4,
        life:30
      });
    }

if(e.hp <= 0){

  bloodPools.push({
    x: e.x,
    y: e.y,
    size: 10 + Math.random()*6
  });

  slowMotion = 6;

  if(!player.ultiActive){
    player.ki += 20;

    if(player.ki > player.maxKi){
      player.ki = player.maxKi;
    }
  }
}
  });

  enemies = enemies.filter(e => e.hp > 0);
}

/* ===== Î†åÎçî ===== */
function draw(){

 ctx.fillStyle="#111";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 let camX=player.x-canvas.width/2;
 let camY=player.y-canvas.height/2;
 let sx=shake?(Math.random()-0.5)*12:0;
 let sy=shake?(Math.random()-0.5)*12:0;

 ctx.save();
 ctx.translate(-camX+sx,-camY+sy);

 let size=40;
 for(let x=-1000;x<1000;x+=size){
  for(let y=-1000;y<1000;y+=size){
   ctx.fillStyle=((x+y)/size)%2==0?"#1a1a1a":"#222";
   ctx.fillRect(x,y,size,size);
  }
 }

 bloodPools.forEach(b=>{
  ctx.fillStyle="#550000";
  ctx.beginPath();
  ctx.arc(b.x,b.y,b.size,0,Math.PI*2);
  ctx.fill();
 });

 particles.forEach(p=>{
  ctx.fillStyle="red";
  ctx.fillRect(p.x,p.y,3,3);
 });

 enemies.forEach(e=>drawEnemy(e));

 ctx.restore();

// üî• ÌÇ¨ Ïàò ÌëúÏãú
ctx.fillStyle = "white";
ctx.font = "20px Arial";
ctx.fillText("KILLS: " + killCount, 20, 30);
 drawPlayer(canvas.width/2,canvas.height/2);
 drawUI();
}

/* ===== ÌîåÎ†àÏù¥Ïñ¥ ===== */
function drawPlayer(x,y){

 ctx.fillStyle="#880000";
 ctx.fillRect(x-10,y-12,20,22);

 ctx.fillStyle="#aa0000";
 ctx.fillRect(x-7,y-20,14,8);

 ctx.fillStyle="#ffffcc";
 ctx.fillRect(x-8,y-26,4,8);
 ctx.fillRect(x+4,y-26,4,8);

 ctx.fillStyle="#fff";
 ctx.fillRect(x-3,y-14,2,2);
 ctx.fillRect(x+1,y-14,2,2);

 drawSword(x,y);
}

/* ===== üî• ÏµúÏ¢Ö Í≥†Ï†ï Ïπº Î™®ÏÖò ===== */
function drawSword(x, y) {

  ctx.save();
  ctx.translate(x, y);

  var offsetX = 0;
  var offsetY = 0;
  var angle = 0;
  var t = attackFrame / 8;

  // ‚ñ∂ RIGHT (Î≤†Í∏∞)
  if (player.dir === "right") {
    offsetX = 18;
    if (attacking) angle = 1.5 * t;
  }

  // ‚óÄ LEFT (Î≤†Í∏∞)
  else if (player.dir === "left") {
    offsetX = -18;
    if (attacking) angle = -1.5 * t;
  }

  // ‚ñ≤ UP (Ï∞åÎ•¥Í∏∞)
  else if (player.dir === "up") {
    offsetY = -18;
    if (attacking) offsetY -= 25 * t;
  }

  // ‚ñº DOWN (Îàà ÏïÑÎûò ÏãúÏûë Ï∞åÎ•¥Í∏∞)
  else if (player.dir === "down") {
    offsetY = 6;          // üî• Îàà ÏïÑÎûò ÏãúÏûë
    angle = Math.PI;
    if (attacking) offsetY += 25 * t;
  }

  ctx.translate(offsetX, offsetY);
  ctx.rotate(angle);

  // ÏÜêÏû°Ïù¥
  ctx.fillStyle = "#552200";
  ctx.fillRect(-2, 6, 4, 8);

  // Í∞ÄÎìú
  ctx.fillStyle = "#bbbbbb";
  ctx.fillRect(-8, 6, 16, 3);

  // ÏπºÎÇ†
  ctx.fillStyle = "#dddddd";
  ctx.fillRect(-2, -20, 4, 26);

  ctx.beginPath();
  ctx.moveTo(-2, -20);
  ctx.lineTo(0, -32);
  ctx.lineTo(2, -20);
  ctx.fill();

  ctx.restore();
}
/* ===== Î™¨Ïä§ÌÑ∞ ===== */
function drawEnemy(e){

  // Î™∏ÌÜµ
  ctx.fillStyle="#006600";
  ctx.fillRect(e.x-10,e.y-12,20,22);

  // Î®∏Î¶¨
  ctx.fillStyle="#00aa00";
  ctx.fillRect(e.x-7,e.y-20,14,8);

  // Îàà
  ctx.fillStyle="red";
  ctx.fillRect(e.x-4,e.y-14,3,3);
  ctx.fillRect(e.x+1,e.y-14,3,3);

  if(e.attackFrame > 0){

    let t = (25 - e.attackFrame) / 25;
    let swingRange = 1.4;

    // üî• Ï¢åÏö∞ ÏôÑÏ†Ñ ÎåÄÏπ≠ ÌöåÏ†Ñ
    let angle = (t - 0.5) * 2 * swingRange * e.swingDir;

    ctx.save();
    ctx.translate(e.x, e.y-5);
    ctx.rotate(angle);

    // üî• Ï§ëÏã¨ Í∏∞Ï§ÄÏúºÎ°ú Ìåî Í∑∏Î¶º (Ï§ëÏöî!)
    ctx.fillStyle="#006600";
    ctx.fillRect(-20,-3,40,6);  // ‚Üê Ïó¨Í∏∞ Î∞îÎÄú

    ctx.restore();
  }
}

/* ===== UI ===== */
function drawUI(){
 let w=200,h=20;
 ctx.fillStyle="#550000";
 ctx.fillRect(20,20,w,h);
 ctx.fillStyle="red";
 ctx.fillRect(20,20,w*(player.hp/player.maxHp),h);
 ctx.strokeStyle="white";
 ctx.strokeRect(20,20,w,h);
}

function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
