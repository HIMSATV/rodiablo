<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Isometric Dungeon</title>
<style>
html,body{
  margin:0;
  overflow:hidden;
  background:#000;
}
canvas{
  display:block;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const TILE_W = 64;
const TILE_H = 32;
const WALL_HEIGHT = 48;

const MAP_W = 40;
const MAP_H = 40;

// ÎûúÎç§ Îßµ
let map = [];
for(let y=0;y<MAP_H;y++){
  map[y]=[];
  for(let x=0;x<MAP_W;x++){
    if(x===0||y===0||x===MAP_W-1||y===MAP_H-1){
      map[y][x]=1;
    }else{
      map[y][x]=Math.random()<0.15?1:0;
    }
  }
}

let player = {
  x: 10,
  y: 10,
  speed: 0.1
};

let keys = {};
document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

let camera = {
  x: player.x,
  y: player.y,
  shake:0
};

function isoToScreen(x,y){
  const relX = x - camera.x;
  const relY = y - camera.y;

  let screenX = (relX - relY)*(TILE_W/2) + canvas.width/2;
  let screenY = (relX + relY)*(TILE_H/2) + canvas.height/2;

  if(camera.shake>0){
    screenX += (Math.random()-0.5)*camera.shake;
    screenY += (Math.random()-0.5)*camera.shake;
  }

  return {x:screenX,y:screenY};
}

function update(){

  let newX = player.x;
  let newY = player.y;

  if(keys["w"]) newY -= player.speed;
  if(keys["s"]) newY += player.speed;
  if(keys["a"]) newX -= player.speed;
  if(keys["d"]) newX += player.speed;

  // Îßµ Í≤ΩÍ≥Ñ Ï†úÌïú
  if(newX>1 && newX<MAP_W-2 && map[Math.floor(player.y)][Math.floor(newX)]===0){
    player.x=newX;
  }
  if(newY>1 && newY<MAP_H-2 && map[Math.floor(newY)][Math.floor(player.x)]===0){
    player.y=newY;
  }

  // üé• Î∂ÄÎìúÎü¨Ïö¥ Ïπ¥Î©îÎùº (Lerp)
  camera.x += (player.x - camera.x)*0.08;
  camera.y += (player.y - camera.y)*0.08;

  // üå™ ÌôîÎ©¥ ÌùîÎì§Î¶º Í∞êÏÜå
  if(camera.shake>0){
    camera.shake *= 0.9;
    if(camera.shake<0.5) camera.shake=0;
  }
}

function drawFloor(x,y){
  const p = isoToScreen(x,y);

  ctx.beginPath();
  ctx.moveTo(p.x,p.y);
  ctx.lineTo(p.x+TILE_W/2,p.y+TILE_H/2);
  ctx.lineTo(p.x,p.y+TILE_H);
  ctx.lineTo(p.x-TILE_W/2,p.y+TILE_H/2);
  ctx.closePath();

  ctx.fillStyle="#2a2a2a";
  ctx.fill();
}

function drawWall(x,y){
  const p = isoToScreen(x,y);

  // top
  ctx.beginPath();
  ctx.moveTo(p.x,p.y-WALL_HEIGHT);
  ctx.lineTo(p.x+TILE_W/2,p.y+TILE_H/2-WALL_HEIGHT);
  ctx.lineTo(p.x,p.y+TILE_H-WALL_HEIGHT);
  ctx.lineTo(p.x-TILE_W/2,p.y+TILE_H/2-WALL_HEIGHT);
  ctx.closePath();
  ctx.fillStyle="#444";
  ctx.fill();

  // right
  ctx.beginPath();
  ctx.moveTo(p.x+TILE_W/2,p.y+TILE_H/2-WALL_HEIGHT);
  ctx.lineTo(p.x+TILE_W/2,p.y+TILE_H/2);
  ctx.lineTo(p.x,p.y+TILE_H);
  ctx.lineTo(p.x,p.y+TILE_H-WALL_HEIGHT);
  ctx.closePath();
  ctx.fillStyle="#333";
  ctx.fill();

  // left
  ctx.beginPath();
  ctx.moveTo(p.x-TILE_W/2,p.y+TILE_H/2-WALL_HEIGHT);
  ctx.lineTo(p.x-TILE_W/2,p.y+TILE_H/2);
  ctx.lineTo(p.x,p.y+TILE_H);
  ctx.lineTo(p.x,p.y+TILE_H-WALL_HEIGHT);
  ctx.closePath();
  ctx.fillStyle="#222";
  ctx.fill();
}

function drawPlayer(){
  const p = isoToScreen(player.x,player.y);

  ctx.fillStyle="white";
  ctx.fillRect(p.x-8,p.y-36,16,36);
}

function drawLighting(){

  ctx.fillStyle="rgba(0,0,0,0.85)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.globalCompositeOperation="destination-out";

  // üî• ÌöÉÎ∂à ÏúÑÏπòÎì§
  const torches = [
    {x:8,y:8},
    {x:20,y:15},
    {x:30,y:25}
  ];

  torches.forEach(t=>{
    const p = isoToScreen(t.x,t.y);
    const gradient = ctx.createRadialGradient(p.x,p.y,10,p.x,p.y,120);
    gradient.addColorStop(0,"rgba(0,0,0,1)");
    gradient.addColorStop(1,"rgba(0,0,0,0)");

    ctx.fillStyle=gradient;
    ctx.beginPath();
    ctx.arc(p.x,p.y,120,0,Math.PI*2);
    ctx.fill();
  });

  // ÌîåÎ†àÏù¥Ïñ¥ Ï£ºÎ≥Ä ÏïΩÌïú Îπõ
  const pp = isoToScreen(player.x,player.y);
  const grad = ctx.createRadialGradient(pp.x,pp.y,10,pp.x,pp.y,100);
  grad.addColorStop(0,"rgba(0,0,0,1)");
  grad.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=grad;
  ctx.beginPath();
  ctx.arc(pp.x,pp.y,100,0,Math.PI*2);
  ctx.fill();

  ctx.globalCompositeOperation="source-over";
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<MAP_H;y++){
    for(let x=0;x<MAP_W;x++){
      drawFloor(x,y);
      if(map[y][x]===1) drawWall(x,y);
    }
  }

  drawPlayer();
  drawLighting();
}

function loop(){
  update();
  render();
  requestAnimationFrame(loop);
}

canvas.addEventListener("click",()=>{
  camera.shake=20; // ÌÅ¥Î¶≠Ïãú ÌôîÎ©¥ ÌùîÎì§Î¶º
});

loop();

window.addEventListener("resize",()=>{
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
});
</script>

</body>
</html>
