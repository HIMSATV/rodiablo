<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Oni Samurai</title>
<style>
body { margin:0; overflow:hidden; background:#111; }
canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const TILE = 64;
const MAP_SIZE = 40;
const ZOOM = 3;

let keys = {};
let touchTarget = null;

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

canvas.addEventListener("touchstart", e=>{
  const t = e.touches[0];
  touchTarget = {x:t.clientX, y:t.clientY};
});

canvas.addEventListener("touchmove", e=>{
  const t = e.touches[0];
  touchTarget = {x:t.clientX, y:t.clientY};
});

canvas.addEventListener("touchend", e=>{
  touchTarget = null;
});

class Player {
  constructor(){
    this.x = 0;
    this.y = 0;
    this.speed = 0.08;
    this.frame = 0;
    this.frameTick = 0;
    this.dir = 0;
  }

  update(){
    let dx = 0, dy = 0;

    if(keys["w"]) dy -= 1;
    if(keys["s"]) dy += 1;
    if(keys["a"]) dx -= 1;
    if(keys["d"]) dx += 1;

    if(touchTarget){
      dx = (touchTarget.x - canvas.width/2)/100;
      dy = (touchTarget.y - canvas.height/2)/100;
    }

    if(dx !==0 || dy !==0){
      this.x += dx*this.speed;
      this.y += dy*this.speed;

      this.frameTick++;
      if(this.frameTick > 10){
        this.frame = (this.frame+1)%4;
        this.frameTick=0;
      }

      this.dir = Math.atan2(dy,dx);
    }
  }

  draw(camX, camY){
    const isoX = (this.x - this.y)*TILE/2;
    const isoY = (this.x + this.y)*TILE/4;

    const screenX = canvas.width/2 + (isoX - camX)*ZOOM;
    const screenY = canvas.height/2 + (isoY - camY)*ZOOM;

    ctx.save();
    ctx.translate(screenX, screenY);
    ctx.scale(ZOOM*1.6, ZOOM*1.6);

    // Í∑∏Î¶ºÏûê
    ctx.fillStyle="rgba(0,0,0,0.4)";
    ctx.beginPath();
    ctx.ellipse(0,8,6,3,0,0,Math.PI*2);
    ctx.fill();

    // Í∞ëÏ£º Î™∏ÌÜµ
    ctx.fillStyle="#7a0000";
    ctx.fillRect(-5,-10,10,12);

    ctx.fillStyle="#aa2222";
    ctx.fillRect(-5,-4,10,3);

    // Îã§Î¶¨ Ïï†ÎãàÎ©îÏù¥ÏÖò
    ctx.fillStyle="#222";
    ctx.fillRect(-3 + (this.frame%2?1:-1),2,3,8);
    ctx.fillRect(1 + (this.frame%2?-1:1),2,3,8);

    // Ìà¨Íµ¨
    ctx.fillStyle="#550000";
    ctx.fillRect(-4,-16,8,6);

    ctx.fillStyle="#330000";
    ctx.fillRect(-3,-13,6,3);

    // üî• Ïò§Îãà Îøî
    ctx.fillStyle="#eee";
    ctx.beginPath();
    ctx.moveTo(-3,-16);
    ctx.lineTo(-6,-22);
    ctx.lineTo(-2,-18);
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(3,-16);
    ctx.lineTo(6,-22);
    ctx.lineTo(2,-18);
    ctx.fill();

    // Ïπ¥ÌÉÄÎÇò
    ctx.strokeStyle="#ddd";
    ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.moveTo(0,-6);
    ctx.lineTo(
      12*Math.cos(this.dir),
      -6+12*Math.sin(this.dir)
    );
    ctx.stroke();

    ctx.restore();
  }
}

const player = new Player();
let camX = 0, camY = 0;

function drawMap(){
  for(let x=-MAP_SIZE;x<MAP_SIZE;x++){
    for(let y=-MAP_SIZE;y<MAP_SIZE;y++){
      const isoX = (x - y)*TILE/2;
      const isoY = (x + y)*TILE/4;

      const screenX = canvas.width/2 + (isoX - camX)*ZOOM;
      const screenY = canvas.height/2 + (isoY - camY)*ZOOM;

      ctx.fillStyle = "#222";
      ctx.beginPath();
      ctx.moveTo(screenX, screenY);
      ctx.lineTo(screenX+TILE/2*ZOOM, screenY+TILE/4*ZOOM);
      ctx.lineTo(screenX, screenY+TILE/2*ZOOM);
      ctx.lineTo(screenX-TILE/2*ZOOM, screenY+TILE/4*ZOOM);
      ctx.closePath();
      ctx.fill();
    }
  }
}

function gameLoop(){
  ctx.fillStyle="#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  player.update();

  camX += ((player.x-player.y)*TILE/2 - camX)*0.1;
  camY += ((player.x+player.y)*TILE/4 - camY)*0.1;

  drawMap();
  player.draw(camX,camY);

  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
