<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Isometric Samurai</title>
<style>
body { margin:0; overflow:hidden; background:#111; }
canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const TILE = 64;
const MAP_SIZE = 40;
const ZOOM = 3;

let keys = {};
let touchTarget = null;

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

canvas.addEventListener("touchstart", e=>{
  const t = e.touches[0];
  touchTarget = {x:t.clientX, y:t.clientY};
});

class Player {
  constructor(){
    this.x = 0;
    this.y = 0;
    this.speed = 0.1;
    this.frame = 0;
    this.frameTick = 0;
    this.dir = 0;
  }

  update(){
    let dx = 0, dy = 0;

    if(keys["w"]) dy -= 1;
    if(keys["s"]) dy += 1;
    if(keys["a"]) dx -= 1;
    if(keys["d"]) dx += 1;

    if(touchTarget){
      let tx = (touchTarget.x - canvas.width/2)/100;
      let ty = (touchTarget.y - canvas.height/2)/100;
      dx = tx;
      dy = ty;
    }

    if(dx !==0 || dy !==0){
      this.x += dx*this.speed;
      this.y += dy*this.speed;

      this.frameTick++;
      if(this.frameTick > 10){
        this.frame = (this.frame+1)%4;
        this.frameTick=0;
      }

      this.dir = Math.atan2(dy,dx);
    }
  }

  draw(camX, camY){
    const isoX = (this.x - this.y)*TILE/2;
    const isoY = (this.x + this.y)*TILE/4;

    const screenX = canvas.width/2 + (isoX - camX)*ZOOM;
    const screenY = canvas.height/2 + (isoY - camY)*ZOOM;

    ctx.save();
    ctx.translate(screenX, screenY);
    ctx.scale(ZOOM,ZOOM);

    // 갑주 몸통
    ctx.fillStyle="#8b0000";
    ctx.fillRect(-4,-8,8,10);

    // 투구
    ctx.fillStyle="#550000";
    ctx.fillRect(-3,-12,6,4);

    // 다리 애니메이션
    ctx.fillStyle="#333";
    ctx.fillRect(-3 + (this.frame%2?1:-1),2,2,6);
    ctx.fillRect(1 + (this.frame%2?-1:1),2,2,6);

    // 카타나
    ctx.strokeStyle="#ddd";
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(0,-6);
    ctx.lineTo(8*Math.cos(this.dir), -6+8*Math.sin(this.dir));
    ctx.stroke();

    ctx.restore();
  }
}

const player = new Player();
let camX = 0, camY = 0;

function drawMap(){
  for(let x=-MAP_SIZE;x<MAP_SIZE;x++){
    for(let y=-MAP_SIZE;y<MAP_SIZE;y++){
      const isoX = (x - y)*TILE/2;
      const isoY = (x + y)*TILE/4;

      const screenX = canvas.width/2 + (isoX - camX)*ZOOM;
      const screenY = canvas.height/2 + (isoY - camY)*ZOOM;

      ctx.fillStyle = "#222";
      ctx.beginPath();
      ctx.moveTo(screenX, screenY);
      ctx.lineTo(screenX+TILE/2*ZOOM, screenY+TILE/4*ZOOM);
      ctx.lineTo(screenX, screenY+TILE/2*ZOOM);
      ctx.lineTo(screenX-TILE/2*ZOOM, screenY+TILE/4*ZOOM);
      ctx.closePath();
      ctx.fill();
    }
  }
}

function gameLoop(){
  ctx.fillStyle="#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  player.update();

  camX += ((player.x-player.y)*TILE/2 - camX)*0.1;
  camY += ((player.x+player.y)*TILE/4 - camY)*0.1;

  drawMap();
  player.draw(camX,camY);

  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
